<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/WORD_NO_DUPLICATE_FEATURE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/WORD_NO_DUPLICATE_FEATURE.md" />
              <option name="updatedContent" value="# Random Word Without Duplication Feature&#10;&#10;## สรุป&#10;ระบบจะไม่ random คำซ้ำกับคำที่เคยใช้ในห้องนั้นๆ แล้ว จนกว่าคำทั้งหมดจะถูกใช้หมด แล้วค่อย reset และเริ่มใช้ใหม่&#10;&#10;## การทำงาน&#10;&#10;### Before (เดิม)&#10;```java&#10;// Pick random word - อาจซ้ำกับเกมก่อนหน้า&#10;CategoryEntity pick = categories.get(new Random().nextInt(categories.size()));&#10;String word = pick.getCategoryName();&#10;```&#10;&#10;### After (แก้ไขแล้ว)&#10;```java&#10;// 1. ดึงประวัติเกมในห้องนี้&#10;List&lt;Game&gt; previousGames = gameManager.getGamesForRoom(roomCode);&#10;&#10;// 2. เก็บ Set ของคำที่เคยใช้แล้ว&#10;Set&lt;String&gt; usedWords = previousGames.stream()&#10;    .map(Game::getWord)&#10;    .filter(Objects::nonNull)&#10;    .collect(Collectors.toSet());&#10;&#10;// 3. กรองเอาเฉพาะคำที่ยังไม่เคยใช้&#10;List&lt;CategoryEntity&gt; availableCategories = categories.stream()&#10;    .filter(cat -&gt; !usedWords.contains(cat.getCategoryName()))&#10;    .collect(Collectors.toList());&#10;&#10;// 4. ถ้าคำหมดแล้ว (ใช้ครบทุกคำ) → reset ให้ใช้ได้ทั้งหมด&#10;if (availableCategories.isEmpty()) {&#10;    availableCategories = new ArrayList&lt;&gt;(categories);&#10;}&#10;&#10;// 5. Random จากคำที่พร้อมใช้งาน&#10;CategoryEntity pick = availableCategories.get(new Random().nextInt(availableCategories.size()));&#10;String word = pick.getCategoryName();&#10;```&#10;&#10;## Logic Flow&#10;&#10;```&#10;┌─────────────────────────────────────────┐&#10;│  Start Game in Room ABCD                │&#10;└───────────────┬─────────────────────────┘&#10;                │&#10;                ▼&#10;┌─────────────────────────────────────────┐&#10;│  Get all categories (total: 100 words)  │&#10;└───────────────┬─────────────────────────┘&#10;                │&#10;                ▼&#10;┌─────────────────────────────────────────┐&#10;│  Get game history for room ABCD         │&#10;│  - Game 1: word = &quot;แมว&quot;                 │&#10;│  - Game 2: word = &quot;หมา&quot;                 │&#10;│  - Game 3: word = &quot;ปลา&quot;                 │&#10;└───────────────┬─────────────────────────┘&#10;                │&#10;                ▼&#10;┌─────────────────────────────────────────┐&#10;│  Create usedWords Set:                  │&#10;│  { &quot;แมว&quot;, &quot;หมา&quot;, &quot;ปลา&quot; }              │&#10;└───────────────┬─────────────────────────┘&#10;                │&#10;                ▼&#10;┌─────────────────────────────────────────┐&#10;│  Filter available categories            │&#10;│  100 - 3 = 97 words available           │&#10;└───────────────┬─────────────────────────┘&#10;                │&#10;                ▼&#10;┌─────────────────────────────────────────┐&#10;│  Random from 97 available words         │&#10;│  Selected: &quot;นก&quot; (not used before)       │&#10;└─────────────────────────────────────────┘&#10;```&#10;&#10;## Edge Cases&#10;&#10;### Case 1: ห้องใหม่ (ไม่มีประวัติ)&#10;```&#10;previousGames = []&#10;usedWords = {}&#10;availableCategories = all categories (100 words)&#10;→ Random ได้ทั้ง 100 คำ&#10;```&#10;&#10;### Case 2: เล่นไปแล้ว 50 เกม&#10;```&#10;previousGames = [Game1, Game2, ..., Game50]&#10;usedWords = {50 unique words}&#10;availableCategories = 100 - 50 = 50 words&#10;→ Random ได้เฉพาะ 50 คำที่ยังไม่ใช้&#10;```&#10;&#10;### Case 3: ใช้คำหมดแล้ว (100 เกม)&#10;```&#10;previousGames = [Game1, Game2, ..., Game100]&#10;usedWords = {100 words} (all used)&#10;availableCategories = [] (empty!)&#10;&#10;→ Reset: availableCategories = all categories (100 words)&#10;→ Random ได้ทั้ง 100 คำอีกครั้ง (เริ่มรอบใหม่)&#10;```&#10;&#10;### Case 4: คำซ้ำในประวัติ (แต่ละเกมอาจมีคำเดิมหลายครั้ง)&#10;```&#10;previousGames:&#10;  - Game 1: word = &quot;แมว&quot;&#10;  - Game 2: word = &quot;หมา&quot;&#10;  - Game 3: word = &quot;แมว&quot;  ← ซ้ำกับ Game 1&#10;  &#10;usedWords = {&quot;แมว&quot;, &quot;หมา&quot;}  ← Set ทำให้ไม่ซ้ำ&#10;→ Count เป็น 2 คำที่ใช้แล้ว (ไม่ใช่ 3)&#10;```&#10;&#10;## Benefits&#10;&#10;### ✅ ไม่ซ้ำคำในห้องเดียวกัน&#10;- ผู้เล่นจะได้เล่นคำใหม่ๆ ในแต่ละเกม&#10;- ไม่น่าเบื่อ ไม่ซ้ำซาก&#10;&#10;### ✅ Reset อัตโนมัติ&#10;- เมื่อใช้คำหมดแล้ว จะ reset ให้เล่นได้ใหม่&#10;- ไม่ต้อง manual reset&#10;&#10;### ✅ แยกตามห้อง&#10;- ห้อง A ใช้คำ &quot;แมว&quot; → ห้อง B ยังใช้ &quot;แมว&quot; ได้&#10;- ประวัติแยกกันตามห้อง&#10;&#10;### ✅ Performance ดี&#10;- ใช้ `Set` สำหรับ lookup → O(1)&#10;- Filter ด้วย Stream → efficient&#10;&#10;## Example Scenarios&#10;&#10;### Scenario 1: เริ่มเล่นครั้งแรก&#10;```&#10;Room: TEST123&#10;Total categories: 100&#10;Previous games: 0&#10;&#10;→ Random from all 100 words&#10;→ Selected: &quot;แมว&quot;&#10;```&#10;&#10;### Scenario 2: เล่นเกมที่ 2&#10;```&#10;Room: TEST123&#10;Total categories: 100&#10;Previous games: 1&#10;  - Game 1: &quot;แมว&quot;&#10;&#10;→ Exclude: &quot;แมว&quot;&#10;→ Available: 99 words&#10;→ Random from 99 words&#10;→ Selected: &quot;หมา&quot;&#10;```&#10;&#10;### Scenario 3: เล่นเกมที่ 101 (ใช้ครบแล้ว)&#10;```&#10;Room: TEST123&#10;Total categories: 100&#10;Previous games: 100&#10;  - Used all 100 words&#10;&#10;→ Available: 0 words (empty!)&#10;→ Reset to all 100 words&#10;→ Random from 100 words&#10;→ Selected: &quot;แมว&quot; (can reuse now)&#10;```&#10;&#10;## Code Changes&#10;&#10;### Modified File&#10;`src/main/java/com/insidergame/insider_api/api/game/GameServiceImpl.java`&#10;&#10;#### Changes:&#10;1. **Line 47-71**: Added logic to:&#10;   - Get game history for room&#10;   - Build set of used words&#10;   - Filter available categories&#10;   - Reset if all words used&#10;   - Random from available words&#10;&#10;## Testing&#10;&#10;### Test Case 1: New Room&#10;```bash&#10;# Setup: 10 words in database&#10;# Room: NEW001 (no history)&#10;&#10;POST /api/room/NEW001/start&#10;→ Should get random word from all 10 words&#10;→ e.g., &quot;แมว&quot;&#10;```&#10;&#10;### Test Case 2: Play Multiple Games&#10;```bash&#10;# Play 5 games in same room&#10;POST /api/room/NEW001/start  # Game 1 → &quot;แมว&quot;&#10;POST /api/room/NEW001/start  # Game 2 → &quot;หมา&quot; (not &quot;แมว&quot;)&#10;POST /api/room/NEW001/start  # Game 3 → &quot;ปลา&quot; (not &quot;แมว&quot; or &quot;หมา&quot;)&#10;POST /api/room/NEW001/start  # Game 4 → &quot;นก&quot;&#10;POST /api/room/NEW001/start  # Game 5 → &quot;ช้าง&quot;&#10;&#10;# Check history&#10;GET /api/game/NEW001/history&#10;→ Should show 5 games with 5 different words&#10;```&#10;&#10;### Test Case 3: Use All Words (Reset Test)&#10;```bash&#10;# Setup: Only 3 words in database&#10;# Play 4 games&#10;&#10;POST /api/room/NEW001/start  # Game 1 → &quot;แมว&quot;&#10;POST /api/room/NEW001/start  # Game 2 → &quot;หมา&quot;&#10;POST /api/room/NEW001/start  # Game 3 → &quot;ปลา&quot;&#10;POST /api/room/NEW001/start  # Game 4 → &quot;แมว&quot; or &quot;หมา&quot; or &quot;ปลา&quot; (reset!)&#10;&#10;# Should allow reusing words after all are used&#10;```&#10;&#10;### Test Case 4: Different Rooms (Isolation Test)&#10;```bash&#10;# Room A and Room B should have independent histories&#10;&#10;POST /api/room/ROOM_A/start  # Game 1 → &quot;แมว&quot;&#10;POST /api/room/ROOM_B/start  # Game 1 → &quot;แมว&quot; (OK! Different room)&#10;&#10;POST /api/room/ROOM_A/start  # Game 2 → &quot;หมา&quot; (not &quot;แมว&quot;)&#10;POST /api/room/ROOM_B/start  # Game 2 → &quot;หมา&quot; (OK! Different room)&#10;```&#10;&#10;## Database Requirements&#10;&#10;ระบบนี้ทำงานกับข้อมูลที่มีอยู่แล้ว ไม่ต้องเพิ่ม table หรือ field ใหม่:&#10;&#10;- ✅ ใช้ `GameManager.getGamesForRoom()` - มีอยู่แล้ว&#10;- ✅ ใช้ `Game.getWord()` - มีอยู่แล้ว&#10;- ✅ ใช้ `CategoryEntity.getCategoryName()` - มีอยู่แล้ว&#10;&#10;## Performance Considerations&#10;&#10;### Memory Usage&#10;- `Set&lt;String&gt; usedWords` - O(n) where n = number of games played&#10;- ถ้าเล่นไป 1000 เกม → usedWords จะมี ~1000 entries&#10;- แต่ละ entry เป็น String (คำ) → ประมาณ 50 bytes/คำ&#10;- **Total**: ~50KB สำหรับ 1000 เกม → **ยอมรับได้**&#10;&#10;### Time Complexity&#10;- Get game history: O(n)&#10;- Build usedWords Set: O(n)&#10;- Filter categories: O(m) where m = total categories&#10;- Random selection: O(1)&#10;- **Total**: O(n + m) → **Very fast**&#10;&#10;### Optimization (ถ้าจำเป็น)&#10;ถ้าห้องมีเกมเยอะมาก (10,000+ games):&#10;```java&#10;// Cache usedWords in RoomManager&#10;private final Map&lt;String, Set&lt;String&gt;&gt; cachedUsedWords = new ConcurrentHashMap&lt;&gt;();&#10;&#10;// Clear cache when game finishes&#10;public void onGameFinished(String roomCode, String word) {&#10;    cachedUsedWords.computeIfAbsent(roomCode, k -&gt; new HashSet&lt;&gt;()).add(word);&#10;}&#10;```&#10;&#10;## Summary&#10;&#10;✅ **เสร็จแล้ว**: ระบบ random คำไม่ซ้ำในห้องเดียวกัน&#10;✅ **Auto-reset**: เมื่อใช้คำครบจะ reset อัตโนมัติ&#10;✅ **แยกตามห้อง**: แต่ละห้องมีประวัติของตัวเอง&#10;✅ **Performance ดี**: ใช้ Set และ Stream efficiently&#10;✅ **No DB changes**: ใช้ structure ที่มีอยู่แล้ว&#10;&#10;**File Changed:**&#10;- `src/main/java/com/insidergame/insider_api/api/game/GameServiceImpl.java`&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/com/insidergame/insider_api/enums/RoomStatus.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/insidergame/insider_api/enums/RoomStatus.java" />
              <option name="originalContent" value="package com.insidergame.insider_api.enums;&#10;&#10;public enum RoomStatus {&#10;    WAITING ,&#10;    PLAYING,&#10;}&#10;" />
              <option name="updatedContent" value="package com.insidergame.insider_api.enums;&#10;&#10;public enum RoomStatus {&#10;    WAITING ,&#10;    PLAYING,&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>